<h1 mat-dialog-title>{{ getTitle() }}</h1>

<div mat-dialog-content>
  <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
    <div class="form-grid">
      <!-- Información básica -->
      <div class="form-section">
        <h3>Información Básica</h3>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Usuario</mat-label>
          <input matInput formControlName="username" placeholder="john_doe">
          <mat-icon matPrefix>person</mat-icon>
          <mat-error *ngIf="username?.hasError('required')">
            El usuario es requerido
          </mat-error>
          <mat-error *ngIf="username?.hasError('minlength')">
            Mínimo 3 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" type="email" placeholder="john@example.com">
          <mat-icon matPrefix>email</mat-icon>
          <mat-error *ngIf="email?.hasError('required')">
            El email es requerido
          </mat-error>
          <mat-error *ngIf="email?.hasError('email')">
            Email inválido
          </mat-error>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="firstName" placeholder="John">
            <mat-icon matPrefix>badge</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Apellido</mat-label>
            <input matInput formControlName="lastName" placeholder="Doe">
            <mat-icon matPrefix>badge</mat-icon>
          </mat-form-field>
        </div>
      </div>

      <!-- Contraseña (solo para creación) -->
      <div class="form-section" *ngIf="data.mode === 'create'">
        <h3>Contraseña</h3>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Contraseña</mat-label>
          <input 
            matInput 
            [type]="passwordVisible ? 'text' : 'password'" 
            formControlName="password" 
            placeholder="Mínimo 6 caracteres"
          >
          <mat-icon matPrefix>lock</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="passwordVisible = !passwordVisible"
          >
            <mat-icon>{{ passwordVisible ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-error *ngIf="password?.hasError('required')">
            La contraseña es requerida
          </mat-error>
          <mat-error *ngIf="password?.hasError('minlength')">
            Mínimo 6 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirmar Contraseña</mat-label>
          <input 
            matInput 
            [type]="confirmPasswordVisible ? 'text' : 'password'" 
            formControlName="confirmPassword" 
            placeholder="Repite la contraseña"
          >
          <mat-icon matPrefix>lock_reset</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="confirmPasswordVisible = !confirmPasswordVisible"
          >
            <mat-icon>{{ confirmPasswordVisible ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-error *ngIf="confirmPassword?.hasError('required')">
            Confirma la contraseña
          </mat-error>
          <mat-error *ngIf="userForm.hasError('mismatch')">
            Las contraseñas no coinciden
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Información de contacto -->
      <div class="form-section">
        <h3>Información de Contacto</h3>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Teléfono</mat-label>
          <input matInput formControlName="phone" placeholder="+1 234 567 890">
          <mat-icon matPrefix>phone</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Dirección</mat-label>
          <textarea matInput formControlName="address" placeholder="Calle, número" rows="2"></textarea>
          <mat-icon matPrefix>location_on</mat-icon>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Ciudad</mat-label>
            <input matInput formControlName="city" placeholder="Ciudad">
            <mat-icon matPrefix>location_city</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Estado</mat-label>
            <input matInput formControlName="state" placeholder="Estado">
            <mat-icon matPrefix>map</mat-icon>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>País</mat-label>
            <input matInput formControlName="country" placeholder="País">
            <mat-icon matPrefix>public</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Código Postal</mat-label>
            <input matInput formControlName="postalCode" placeholder="00000">
            <mat-icon matPrefix>markunread_mailbox</mat-icon>
          </mat-form-field>
        </div>
      </div>

      <!-- Roles y estado -->
      <div class="form-section">
        <h3>Roles y Estado</h3>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Roles</mat-label>
          <mat-select formControlName="roleIds" multiple>
            <mat-option *ngFor="let role of roles" [value]="role.id">
              {{ role.name }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>admin_panel_settings</mat-icon>
        </mat-form-field>

        <div class="form-checkboxes">
          <mat-checkbox formControlName="isActive" color="primary">
            Usuario activo
          </mat-checkbox>
          
          <mat-checkbox formControlName="isTwoFactorEnabled" color="primary">
            Autenticación en dos pasos habilitada
          </mat-checkbox>
        </div>
      </div>
    </div>
  </form>
</div>

<div mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="loading">
    Cancelar
  </button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="onSubmit()"
    [disabled]="loading || userForm.invalid"
  >
    <span *ngIf="!loading">{{ getButtonText() }}</span>
    <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
  </button>
</div>
